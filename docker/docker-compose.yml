#
# docker-compose.yml â€” Dual-QEMU SemperOS boot test
#
# Sub-task 07b: Two QEMU instances boot the SAME image, connected by
# QEMU socket networking. Both run 8/8 tests independently.
# e1000 NIC (82540EM, 8086:100E) visible on both nodes.
#
# Key: -nic none disables the Q35 default e1000e (82574L, 8086:10d3)
# so that -device e1000 places the 82540EM at PCI slot 2.
#
# Usage:
#   cd docker/
#   docker compose up 2>&1 | tee ../qemu-task07-dual-boot.log
#

services:
  node-a:
    image: semperos-qemu:latest
    container_name: semperos-node-a
    volumes:
      - ../../../build-node0/images:/sel4-image:ro
    network_mode: host
    environment:
      TIMEOUT: "45"
    command:
      - -nic
      - none
      - -device
      - e1000,netdev=eth0,mac=52:54:00:00:00:01
      - -netdev
      - "socket,id=eth0,listen=:10001"

  node-b:
    image: semperos-qemu:latest
    container_name: semperos-node-b
    volumes:
      - ../../../build-node0/images:/sel4-image:ro
    network_mode: host
    environment:
      TIMEOUT: "45"
    depends_on:
      - node-a
    entrypoint: ["sh", "-c", "sleep 3 && /run-qemu.sh -nic none -device e1000,netdev=eth0,mac=52:54:00:00:00:02 -netdev socket,id=eth0,connect=127.0.0.1:10001"]
